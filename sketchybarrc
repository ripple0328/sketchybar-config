#!/usr/bin/env bash

# SketchyBar configuration for Aerospace window manager
# This configuration removes Yabai dependencies and properly integrates with Aerospace
# Font used for all of sketchybar
FONT="MesloLGS Nerd Font"
ITEM_DIR="$HOME/.config/sketchybar/items"       # Directory where the items are configured
PLUGIN_DIR="$HOME/.config/sketchybar/plugins"   # Directory where plugin scripts are stored
source "$HOME/.config/sketchybar/colors.sh"     # Loads all defined colors
source "$HOME/.config/sketchybar/icons.sh" # Loads all defined icons
PADDINGS=3

##### Bar Appearance #####
bar=(
  height=39
  color=$BAR_COLOR
  shadow=on
  position=top
  sticky=on
  padding_right=10
  padding_left=10
  corner_radius=15
  y_offset=3
  margin=5
  blur_radius=20
  notch_width=0
)

sketchybar --bar "${bar[@]}"
#sketchybar --bar position=top height=30 blur_radius=30 color=0x40000000 corner_radius=15

##### Changing Defaults #####
# Default values applied to all items
# Setting up default values
defaults=(
  updates=when_shown
  icon.font="$FONT:Regular:16.0"
  icon.color=$ICON_COLOR
  icon.padding_left=$PADDINGS
  icon.padding_right=0
  label.font="$FONT:Regular:10.0"
  label.color=$LABEL_COLOR
  label.padding_left=0
  label.padding_right=$PADDINGS
  background.padding_right=$PADDINGS
  background.padding_left=$PADDINGS
  background.height=30
  background.corner_radius=10
  popup.background.border_width=2
  popup.background.corner_radius=10
  popup.background.border_color=$POPUP_BORDER_COLOR
  popup.background.color=$POPUP_BACKGROUND_COLOR
  popup.blur_radius=20
  popup.background.shadow.drawing=on
)

sketchybar --default "${defaults[@]}"

##### Aerospace Workspace Indicators #####
# Add events for aerospace workspace and mode changes
sketchybar --add event aerospace_workspace_change
sketchybar --add event aerospace_mode_change


source "$ITEM_DIR/apple.sh"
# Get all workspaces from aerospace and create items for them
for sid in $(aerospace list-workspaces --all); do
    sketchybar --add item space.$sid left \
        --subscribe space.$sid aerospace_workspace_change \
        --set space.$sid \
        background.color=0x44ffffff \
        background.corner_radius=5 \
        background.height=25 \
        background.drawing=off \
        label="$sid" \
        label.padding_left=$PADDINGS \
        label.padding_right=$PADDINGS \
        label.color=0xffffffff \
        click_script="$PLUGIN_DIR/workspace_click.sh $sid" \
        script="$PLUGIN_DIR/aerospace.sh $sid"
done

##### Aerospace Mode Indicator #####
# Add mode indicator (only visible when not in main mode)
sketchybar --add item aerospace_mode left \
           --set aerospace_mode \
           drawing=off \
           script="$PLUGIN_DIR/aerospace_mode.sh" \
           click_script="aerospace mode main && sketchybar --trigger aerospace_mode_change AEROSPACE_MODE=main" \
           --subscribe aerospace_mode aerospace_mode_change

##### Adding Left Items #####
sketchybar --add item chevron left \
           --set chevron icon=ó°…‚ label.drawing=off \
           --add item front_app left \
           --set front_app icon.drawing=off script="$PLUGIN_DIR/front_app.sh" \
           click_script="$PLUGIN_DIR/front_app_click.sh" \
           --subscribe front_app front_app_switched

##### Adding Right Items #####
# Clock
sketchybar --add item clock right \
           --set clock update_freq=10 icon.drawing=off script="$PLUGIN_DIR/clock.sh" \
           click_script="open -a Clock"

# Calendar
sketchybar --add item calendar right \
           --set calendar update_freq=10 icon.drawing=off script="$PLUGIN_DIR/calendar.sh" \
           click_script="open -a Calendar"

# Volume
sketchybar --add item volume right \
           --set volume script="$PLUGIN_DIR/volume.sh" \
           click_script="$PLUGIN_DIR/volume_click.sh" \
           --subscribe volume volume_change

# Battery (simple display for desktop - no click needed)
sketchybar --add item battery right \
           --set battery update_freq=120 script="$PLUGIN_DIR/battery.sh" \
           --subscribe battery system_woke power_source_change


##### Force all scripts to run the first time #####
sketchybar --update

# Initialize aerospace mode indicator on startup
sketchybar --trigger aerospace_mode_change
