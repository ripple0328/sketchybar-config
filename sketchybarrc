#!/usr/bin/env bash

# SketchyBar configuration for Aerospace window manager
# This configuration creates segmented bars with adaptive widths

# Configuration
FONT="MesloLGS Nerd Font"
ITEM_DIR="$HOME/.config/sketchybar/items"       # Directory where the items are configured
PLUGIN_DIR="$HOME/.config/sketchybar/plugins"   # Directory where plugin scripts are stored
source "$HOME/.config/sketchybar/colors.sh"     # Loads all defined colors
source "$HOME/.config/sketchybar/icons.sh"      # Loads all defined icons
PADDINGS=3

##### Bar Appearance #####
# Transparent main bar to let segments show through
bar=(
  height=35
  color=$TRANSPARENT
  shadow=off
  position=top
  sticky=on
  padding_right=12
  padding_left=12
  corner_radius=18
  y_offset=3
  margin=0
  blur_radius=0
  notch_width=0
)

sketchybar --bar "${bar[@]}"

##### Default Item Settings #####
defaults=(
  updates=when_shown
  icon.font="$FONT:Regular:16.0"
  icon.color=$ICON_COLOR
  icon.padding_left=$PADDINGS
  icon.padding_right=2
  label.font="$FONT:Regular:10.0"
  label.color=$LABEL_COLOR
  label.padding_left=2
  label.padding_right=$PADDINGS
  background.padding_right=$PADDINGS
  background.padding_left=$PADDINGS
  background.height=30
  background.corner_radius=10
  popup.background.border_width=2
  popup.background.corner_radius=10
  popup.background.border_color=$POPUP_BORDER_COLOR
  popup.background.color=$POPUP_BACKGROUND_COLOR
  popup.blur_radius=20
  popup.background.shadow.drawing=on
)

sketchybar --default "${defaults[@]}"

##### Events #####
sketchybar --add event aerospace_workspace_change
sketchybar --add event aerospace_mode_change

# Add event handler for workspace changes to trigger app icon refresh
sketchybar --add item aerospace_event_handler left \
    --set aerospace_event_handler \
    script="$HOME/.config/sketchybar/plugins/refresh_workspaces.sh" \
    drawing=off \
    --subscribe aerospace_event_handler aerospace_workspace_change



##### Load Item Files #####
# Load all items from separate files
source "$ITEM_DIR/apple.sh"
source "$ITEM_DIR/workspaces.sh"
source "$ITEM_DIR/spacers.sh"
source "$ITEM_DIR/app_info.sh"
source "$ITEM_DIR/system_status.sh"
source "$ITEM_DIR/aerospace_mode.sh"

##### Create Segments with Brackets #####
# Read workspace items from temp file
WORKSPACE_ITEMS=($(cat /tmp/sketchybar_workspace_items 2>/dev/null || echo ""))

# Left Segment 1: Apple Logo + Workspaces
if [ ${#WORKSPACE_ITEMS[@]} -gt 0 ]; then
    sketchybar --add bracket apple_spaces apple.logo "${WORKSPACE_ITEMS[@]}" \
               --set apple_spaces background.color=$BACKGROUND_1 \
                                 background.corner_radius=16 \
                                 background.height=32
else
    # Fallback if no workspaces found
    sketchybar --add bracket apple_spaces apple.logo \
               --set apple_spaces background.color=$BACKGROUND_1 \
                                 background.corner_radius=16 \
                                 background.height=32
fi

# Left Segment 2: App Info (chevron + front app)
sketchybar --add bracket app_info chevron front_app \
           --set app_info background.color=$BACKGROUND_1 \
                         background.corner_radius=16 \
                         background.height=32

# Center Segment: Aerospace Mode (when visible)
sketchybar --add bracket aerospace_mode_bracket aerospace_mode \
           --set aerospace_mode_bracket background.color=$RED \
                                       background.corner_radius=16 \
                                       background.height=32

# Right Segment: System Status (battery, volume, calendar, clock)
sketchybar --add bracket system_status battery volume calendar clock \
           --set system_status background.color=$BACKGROUND_1 \
                              background.corner_radius=16 \
                              background.height=32

##### Finalize #####
sketchybar --update

# Initialize aerospace mode indicator
sketchybar --trigger aerospace_mode_change
